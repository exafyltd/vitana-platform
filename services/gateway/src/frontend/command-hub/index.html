<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitana Command HUB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0e1a; color: #e4e4e7; height: 100vh; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid #334155; padding: 0; display: flex; flex-direction: column; }
        .header-top { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 1.5rem; font-weight: 700; color: #60a5fa; display: flex; align-items: center; gap: 0.5rem; }
        .status-indicator { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; color: #94a3b8; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .nav-tabs { display: flex; gap: 0; padding: 0 1.5rem; background: #0f172a; }
        .nav-tab { padding: 0.75rem 1.5rem; background: transparent; border: none; color: #94a3b8; font-size: 0.875rem; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .nav-tab:hover { color: #e4e4e7; background: rgba(96, 165, 250, 0.05); }
        .nav-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .app-content { flex: 1; overflow: hidden; position: relative; }
        .tab-panel { display: none; height: 100%; overflow: auto; }
        .tab-panel.active { display: block; }
        .live-console { display: flex; height: 100%; }
        .event-ticker { width: 40%; border-right: 1px solid #334155; padding: 1.5rem; overflow-y: auto; }
        .event-ticker h2 { font-size: 1.25rem; color: #60a5fa; margin-bottom: 1rem; }
        .event-item { background: #1e293b; border-radius: 6px; padding: 0.875rem; margin-bottom: 0.75rem; border-left: 3px solid #60a5fa; font-size: 0.875rem; }
        .event-type { font-weight: 600; margin-bottom: 0.25rem; color: #e4e4e7; }
        .event-meta { font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; }
        .chat-panel { width: 60%; display: flex; flex-direction: column; }
        .chat-header { padding: 1.5rem; border-bottom: 1px solid #334155; }
        .chat-header h2 { color: #60a5fa; font-size: 1.25rem; margin-bottom: 0.25rem; }
        .chat-subtitle { font-size: 0.75rem; color: #64748b; }
        .chat-messages { flex: 1; padding: 1.5rem; overflow-y: auto; }
        .message { background: #1e293b; border-radius: 6px; padding: 0.875rem; margin-bottom: 0.875rem; border-left: 3px solid #60a5fa; }
        .message.user { border-left-color: #10b981; }
        .chat-input-box { padding: 1.5rem; border-top: 1px solid #334155; display: flex; gap: 0.75rem; }
        .chat-input { flex: 1; padding: 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 6px; color: #e4e4e7; font-size: 0.875rem; }
        .chat-input:focus { outline: none; border-color: #60a5fa; }
        .send-btn { padding: 0.75rem 1.5rem; background: #60a5fa; color: #fff; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s ease; }
        .send-btn:hover { background: #3b82f6; }
        .tasks-view { height: 100%; display: flex; flex-direction: column; }
        .tasks-header { padding: 1.5rem; border-bottom: 1px solid #334155; background: #0f172a; }
        .tasks-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .tasks-title { font-size: 1.5rem; font-weight: 600; color: #e4e4e7; }
        .tasks-stats { display: flex; gap: 1.5rem; }
        .stat-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .stat-label { color: #64748b; }
        .stat-value { font-weight: 600; color: #60a5fa; }
        .tasks-filters { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .filter-select { padding: 0.5rem 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 6px; color: #e4e4e7; font-size: 0.875rem; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: #60a5fa; }
        .search-input { flex: 1; min-width: 200px; padding: 0.5rem 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 6px; color: #e4e4e7; font-size: 0.875rem; }
        .search-input:focus { outline: none; border-color: #60a5fa; }
        .tasks-content { flex: 1; display: flex; gap: 1px; background: #334155; overflow: hidden; }
        .task-panel { flex: 1; background: #0a0e1a; overflow-y: auto; padding: 1.5rem; }
        .panel-header { font-size: 1rem; font-weight: 600; color: #e4e4e7; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #334155; }
        .task-group { margin-bottom: 1.5rem; }
        .group-label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; }
        .task-card { background: #1e293b; border-radius: 6px; padding: 0.875rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s ease; border-left: 3px solid #334155; }
        .task-card:hover { background: #283548; border-left-color: #60a5fa; transform: translateX(2px); }
        .task-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .task-vtid { font-family: 'Courier New', monospace; font-size: 0.75rem; font-weight: 600; color: #60a5fa; padding: 0.25rem 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 4px; }
        .task-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 500; }
        .task-status.pending { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
        .task-status.active { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .task-status.blocked { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .task-status.complete { background: rgba(148, 163, 184, 0.1); color: #94a3b8; }
        .task-title { font-size: 0.875rem; font-weight: 500; color: #e4e4e7; margin-bottom: 0.5rem; line-height: 1.4; }
        .task-meta { display: flex; gap: 1rem; font-size: 0.75rem; color: #64748b; }
        .task-meta-item { display: flex; align-items: center; gap: 0.25rem; }
        .priority-badge { font-weight: 600; padding: 0.125rem 0.375rem; border-radius: 3px; }
        .priority-badge.p0 { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .priority-badge.p1 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .priority-badge.p2 { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .task-drawer { position: fixed; right: 0; top: 0; width: 500px; height: 100vh; background: #0f172a; border-left: 1px solid #334155; transform: translateX(100%); transition: transform 0.3s ease; z-index: 1000; display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5); }
        .task-drawer.open { transform: translateX(0); }
        .drawer-header { padding: 1.5rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: flex-start; }
        .drawer-title { font-size: 1.125rem; font-weight: 600; color: #e4e4e7; margin-bottom: 0.5rem; }
        .drawer-vtid { font-family: 'Courier New', monospace; font-size: 0.875rem; color: #60a5fa; }
        .close-drawer { background: transparent; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s ease; }
        .close-drawer:hover { background: #1e293b; color: #e4e4e7; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .drawer-section { margin-bottom: 2rem; }
        .section-title { font-size: 0.875rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .info-item { background: #1e293b; padding: 0.75rem; border-radius: 6px; }
        .info-label { font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; }
        .info-value { font-size: 0.875rem; color: #e4e4e7; font-weight: 500; }
        .timeline-item { position: relative; padding-left: 1.5rem; margin-bottom: 1rem; padding-bottom: 1rem; border-left: 2px solid #334155; }
        .timeline-item:last-child { border-left-color: transparent; }
        .timeline-dot { position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: #60a5fa; }
        .timeline-content { background: #1e293b; padding: 0.75rem; border-radius: 6px; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .timeline-event { font-size: 0.875rem; font-weight: 500; color: #e4e4e7; }
        .timeline-time { font-size: 0.75rem; color: #64748b; }
        .timeline-message { font-size: 0.75rem; color: #94a3b8; }
        .copy-brief-btn { width: 100%; padding: 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 6px; color: #e4e4e7; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .copy-brief-btn:hover { background: #283548; border-color: #60a5fa; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
        .drawer-overlay.open { display: block; }
        .loading { text-align: center; padding: 2rem; color: #64748b; font-size: 0.875rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state-text { font-size: 0.875rem; }
        @media (max-width: 1024px) {
            .tasks-content { flex-direction: column; }
            .task-panel { min-height: 300px; }
            .task-drawer { width: 100%; }
            .live-console { flex-direction: column; }
            .event-ticker, .chat-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-top">
                <h1 class="app-title"><span>âš¡</span><span>Vitana Command HUB</span></h1>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="status-text">Connected</span>
                </div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="live">LIVE Console</button>
                <button class="nav-tab" data-tab="tasks">Tasks</button>
            </nav>
        </header>
        <main class="app-content">
            <div class="tab-panel active" id="panel-live">
                <div class="live-console">
                    <div class="event-ticker">
                        <h2>Live Events</h2>
                        <div id="events-list"><div class="loading">Loading events</div></div>
                    </div>
                    <div class="chat-panel">
                        <div class="chat-header">
                            <h2>Command Hub</h2>
                            <p class="chat-subtitle">Ask naturally | /help for commands</p>
                        </div>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input-box">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Type message...">
                            <button class="send-btn" id="send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-panel" id="panel-tasks">
                <div class="tasks-view">
                    <div class="tasks-header">
                        <div class="tasks-title-row">
                            <h2 class="tasks-title">Tasks</h2>
                            <div class="tasks-stats">
                                <div class="stat-item"><span class="stat-label">Scheduled:</span><span class="stat-value" id="stat-scheduled">0</span></div>
                                <div class="stat-item"><span class="stat-label">Active:</span><span class="stat-value" id="stat-active">0</span></div>
                                <div class="stat-item"><span class="stat-label">Completed:</span><span class="stat-value" id="stat-completed">0</span></div>
                            </div>
                        </div>
                        <div class="tasks-filters">
                            <select class="filter-select" id="filter-layer">
                                <option value="">All Layers</option>
                                <option value="CICDL">CICDL</option>
                                <option value="COMMU">COMMU</option>
                                <option value="AGENT">AGENT</option>
                                <option value="API">API</option>
                                <option value="INFRA">INFRA</option>
                            </select>
                            <select class="filter-select" id="filter-priority">
                                <option value="">All Priorities</option>
                                <option value="P0">P0</option>
                                <option value="P1">P1</option>
                                <option value="P2">P2</option>
                            </select>
                            <select class="filter-select" id="filter-status">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                                <option value="complete">Complete</option>
                            </select>
                            <input type="text" class="search-input" id="search-input" placeholder="Search tasks...">
                        </div>
                    </div>
                    <div class="tasks-content">
                        <div class="task-panel"><div class="panel-header">Scheduled</div><div id="scheduled-content"><div class="loading">Loading scheduled tasks</div></div></div>
                        <div class="task-panel"><div class="panel-header">Catalog</div><div id="catalog-content"><div class="loading">Loading catalog</div></div></div>
                        <div class="task-panel"><div class="panel-header">Completed</div><div id="completed-content"><div class="loading">Loading completed tasks</div></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="drawer-overlay" id="drawer-overlay"></div>
    <div class="task-drawer" id="task-drawer">
        <div class="drawer-header">
            <div><div class="drawer-vtid" id="drawer-vtid">Loading...</div><div class="drawer-title" id="drawer-title">Loading...</div></div>
            <button class="close-drawer" id="close-drawer">&times;</button>
        </div>
        <div class="drawer-content" id="drawer-content"><div class="loading">Loading task details</div></div>
    </div>
    <script>
        const state = {currentTab:'live',tasks:{scheduled:[],catalog:[],completed:[]},filters:{layer:'',priority:'',status:'',search:''}};
        const API = {
            async getTasks(f={}){const p=new URLSearchParams();if(f.status)p.append('status',f.status);if(f.layer)p.append('taskFamily',f.layer);p.append('limit','100');const r=await fetch(`/api/v1/vtid/list?${p}`);const d=await r.json();return d.ok?d.data:[]},
            async getTaskDetails(v){const r=await fetch(`/api/v1/vtid/${v}`);const d=await r.json();return d.ok?d.data:null},
            async getTaskEvents(v){const r=await fetch(`/api/v1/events?vtid=${v}&limit=20`);return await r.json()},
            async sendChatMessage(m){const r=await fetch('/command-hub/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})});const d=await r.json();return d.response||d.text||'No response'}
        };
        function processVtids(vtids){return vtids.filter(vtid=>{const titleCandidate=vtid.description||vtid.title||vtid.name;if(!vtid.vtid||!titleCandidate)return false;return true})}
        function switchTab(t){state.currentTab=t;document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id===`panel-${t}`));if(t==='tasks')loadTasksData();else if(t==='live')loadLiveEvents()}
        async function loadTasksData(){try{const rawTasks=await API.getTasks();const all=processVtids(rawTasks);state.tasks.scheduled=all.filter(t=>['pending','active','blocked'].includes(t.status));state.tasks.catalog=all;state.tasks.completed=all.filter(t=>t.status==='complete');document.getElementById('stat-scheduled').textContent=state.tasks.scheduled.length;document.getElementById('stat-active').textContent=state.tasks.scheduled.filter(t=>t.status==='active').length;document.getElementById('stat-completed').textContent=state.tasks.completed.length;renderScheduledPanel();renderCatalogPanel();renderCompletedPanel()}catch(e){console.error('Error loading tasks:',e)}}
        function renderScheduledPanel(){const c=document.getElementById('scheduled-content');const t=applyFilters(state.tasks.scheduled);if(!t.length){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><div class="empty-state-text">No scheduled tasks</div></div>';return}const now=t.filter(x=>x.status==='active');const next=t.filter(x=>x.status==='pending'&&(x.metadata?.priority==='P0'||x.metadata?.priority==='P1'));const later=t.filter(x=>x.status==='pending'&&x.metadata?.priority!=='P0'&&x.metadata?.priority!=='P1');const blocked=t.filter(x=>x.status==='blocked');let h='';if(now.length){h+='<div class="task-group"><div class="group-label">Now</div>'+now.map(renderTaskCard).join('')+'</div>'}if(next.length){h+='<div class="task-group"><div class="group-label">Next</div>'+next.map(renderTaskCard).join('')+'</div>'}if(later.length){h+='<div class="task-group"><div class="group-label">Later</div>'+later.map(renderTaskCard).join('')+'</div>'}if(blocked.length){h+='<div class="task-group"><div class="group-label">Blocked</div>'+blocked.map(renderTaskCard).join('')+'</div>'}c.innerHTML=h}
        function renderCatalogPanel(){const c=document.getElementById('catalog-content');const t=applyFilters(state.tasks.catalog);if(!t.length){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">ðŸ“š</div><div class="empty-state-text">No tasks found</div></div>';return}c.innerHTML=t.map(renderTaskCard).join('')}
        function renderCompletedPanel(){const c=document.getElementById('completed-content');const t=applyFilters(state.tasks.completed);if(!t.length){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">âœ…</div><div class="empty-state-text">No completed tasks</div></div>';return}const now=new Date();const today=t.filter(x=>isToday(new Date(x.updated_at)));const yesterday=t.filter(x=>isYesterday(new Date(x.updated_at)));const lastWeek=t.filter(x=>{const d=new Date(x.updated_at);return!isToday(d)&&!isYesterday(d)&&isWithinDays(d,7)});const older=t.filter(x=>!isWithinDays(new Date(x.updated_at),7));let h='';if(today.length){h+='<div class="task-group"><div class="group-label">Today</div>'+today.map(renderTaskCard).join('')+'</div>'}if(yesterday.length){h+='<div class="task-group"><div class="group-label">Yesterday</div>'+yesterday.map(renderTaskCard).join('')+'</div>'}if(lastWeek.length){h+='<div class="task-group"><div class="group-label">Last 7 Days</div>'+lastWeek.map(renderTaskCard).join('')+'</div>'}if(older.length){h+='<div class="task-group"><div class="group-label">Older</div>'+older.map(renderTaskCard).join('')+'</div>'}c.innerHTML=h}
        function renderTaskCard(t){const p=t.metadata?.priority||'P2';const l=extractLayer(t.vtid);const o=t.assigned_to||'Unassigned';const time=formatRelativeTime(new Date(t.updated_at));const title=t.description||t.title||t.name||t.task_type;return`<div class="task-card" onclick="openTaskDrawer('${t.vtid}')"><div class="task-card-header"><div class="task-vtid">${t.vtid}</div><div class="task-status ${t.status}">${t.status}</div></div><div class="task-title">${title}</div><div class="task-meta"><div class="task-meta-item"><span class="priority-badge ${p.toLowerCase()}">${p}</span></div><div class="task-meta-item">ðŸ‘¤ ${o}</div><div class="task-meta-item">ðŸ•’ ${time}</div></div></div>`}
        function applyFilters(t){return t.filter(x=>{if(state.filters.layer&&extractLayer(x.vtid)!==state.filters.layer)return false;if(state.filters.priority&&x.metadata?.priority!==state.filters.priority)return false;if(state.filters.status&&x.status!==state.filters.status)return false;if(state.filters.search){const s=state.filters.search.toLowerCase();const txt=`${x.vtid} ${x.description||x.title||x.name||''} ${x.task_type}`.toLowerCase();if(!txt.includes(s))return false}return true})}
        async function openTaskDrawer(v){const d=document.getElementById('task-drawer');const o=document.getElementById('drawer-overlay');d.classList.add('open');o.classList.add('open');document.getElementById('drawer-vtid').textContent=v;document.getElementById('drawer-title').textContent='Loading...';document.getElementById('drawer-content').innerHTML='<div class="loading">Loading task details</div>';try{const t=await API.getTaskDetails(v);const e=await API.getTaskEvents(v);if(t)renderTaskDrawer(t,e)}catch(err){console.error('Error:',err);document.getElementById('drawer-content').innerHTML='<div class="empty-state"><div class="empty-state-text">Error loading task details</div></div>'}}
        function renderTaskDrawer(t,e){const title=t.description||t.title||t.name||t.task_type;document.getElementById('drawer-title').textContent=title;const p=t.metadata?.priority||'P2';const l=extractLayer(t.vtid);const o=t.assigned_to||'Unassigned';let h=`<div class="drawer-section"><div class="section-title">Details</div><div class="info-grid"><div class="info-item"><div class="info-label">Status</div><div class="info-value">${t.status}</div></div><div class="info-item"><div class="info-label">Priority</div><div class="info-value">${p}</div></div><div class="info-item"><div class="info-label">Layer</div><div class="info-value">${l}</div></div><div class="info-item"><div class="info-label">Owner</div><div class="info-value">${o}</div></div></div></div>`;if(e&&e.length){h+='<div class="drawer-section"><div class="section-title">Timeline</div>';e.forEach(ev=>{const time=formatDateTime(new Date(ev.created_at));h+=`<div class="timeline-item"><div class="timeline-dot"></div><div class="timeline-content"><div class="timeline-header"><div class="timeline-event">${ev.event_type||ev.topic}</div><div class="timeline-time">${time}</div></div><div class="timeline-message">${ev.message||ev.notes||''}</div></div></div>`});h+='</div>'}h+=`<div class="drawer-section"><div class="section-title">Specification</div><div class="info-item"><div class="info-label">Task Family</div><div class="info-value">${t.task_family}</div></div><div class="info-item" style="margin-top:0.75rem"><div class="info-label">Task Type</div><div class="info-value">${t.task_type}</div></div><div class="info-item" style="margin-top:0.75rem"><div class="info-label">Description</div><div class="info-value">${title}</div></div><button class="copy-brief-btn" onclick="copyTaskBrief('${t.vtid}')">ðŸ“‹ Copy Task Brief</button></div>`;if(t.metadata&&Object.keys(t.metadata).length){h+=`<div class="drawer-section"><div class="section-title">Metadata</div><div class="info-item"><pre style="font-size:0.75rem;color:#94a3b8;overflow-x:auto">${JSON.stringify(t.metadata,null,2)}</pre></div></div>`}document.getElementById('drawer-content').innerHTML=h}
        function closeTaskDrawer(){document.getElementById('task-drawer').classList.remove('open');document.getElementById('drawer-overlay').classList.remove('open')}
        async function copyTaskBrief(v){try{const t=await API.getTaskDetails(v);if(!t)return;const title=t.description||t.title||t.name||t.task_type;const b=`VTID: ${t.vtid}\nTask Family: ${t.task_family}\nTask Type: ${t.task_type}\nStatus: ${t.status}\nPriority: ${t.metadata?.priority||'P2'}\nAssigned To: ${t.assigned_to||'Unassigned'}\n\nDescription:\n${title}\n\n${t.metadata?`Metadata:\n${JSON.stringify(t.metadata,null,2)}`:''}`.trim();await navigator.clipboard.writeText(b);alert('Task brief copied to clipboard!')}catch(err){console.error('Error:',err)}}
        let seenEventIds=new Set();
        async function loadLiveEvents(){try{const r=await fetch('/api/v1/events?limit=20');const e=await r.json();if(e.ok && Array.isArray(e.data)){const data=e.data;const c=document.getElementById('events-list');c.innerHTML='';data.reverse().forEach(ev=>{if(!seenEventIds.has(ev.id)){seenEventIds.add(ev.id);addEventToList(ev)}})}}catch(err){console.error('Error:',err)}}
        function addEventToList(ev){const c=document.getElementById('events-list');const e=document.createElement('div');e.className='event-item';const type=ev.topic||ev.event_type||'event';const msg=ev.message||ev.service||'';const time=formatTime(new Date(ev.created_at));const vtid=ev.vtid&&ev.vtid!=='UNSET'?ev.vtid:'';e.innerHTML=`<div class="event-type">${type}${vtid?` [${vtid}]`:''}</div><div class="event-meta">${msg}${time?` â€¢ ${time}`:''}</div>`;c.insertBefore(e,c.firstChild);while(c.children.length>50)c.removeChild(c.lastChild)}
        function addChatMessage(t,u){const c=document.getElementById('chat-messages');const m=document.createElement('div');m.className='message'+(u?' user':'');m.textContent=t;c.appendChild(m);c.scrollTop=c.scrollHeight}
        async function sendChatMessage(){const i=document.getElementById('chat-input');const m=i.value.trim();if(!m)return;i.value='';addChatMessage(m,true);try{const r=await API.sendChatMessage(m);addChatMessage(r,false);i.focus()}catch(err){console.error('Error:',err);addChatMessage('Error: '+err.message,false);i.focus()}}
        function extractLayer(v){const p=v.split('-');return p[1]||'UNKNOWN'}
        function formatRelativeTime(d){const now=new Date();const diff=now-d;const mins=Math.floor(diff/60000);const hours=Math.floor(diff/3600000);const days=Math.floor(diff/86400000);if(mins<1)return'just now';if(mins<60)return`${mins}m ago`;if(hours<24)return`${hours}h ago`;return`${days}d ago`}
        function formatTime(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}
        function formatDateTime(d){return d.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}
        function isToday(d){const t=new Date();return d.toDateString()===t.toDateString()}
        function isYesterday(d){const y=new Date();y.setDate(y.getDate()-1);return d.toDateString()===y.toDateString()}
        function isWithinDays(d,n){const now=new Date();return(now-d)<(n*86400000)}
        document.querySelectorAll('.nav-tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
        document.getElementById('close-drawer').addEventListener('click',closeTaskDrawer);
        document.getElementById('drawer-overlay').addEventListener('click',closeTaskDrawer);
        ['layer','priority','status'].forEach(f=>{document.getElementById(`filter-${f}`).addEventListener('change',e=>{state.filters[f]=e.target.value;renderScheduledPanel();renderCatalogPanel();renderCompletedPanel()})});
        document.getElementById('search-input').addEventListener('input',e=>{state.filters.search=e.target.value;renderScheduledPanel();renderCatalogPanel();renderCompletedPanel()});
        document.getElementById('send-btn').addEventListener('click',sendChatMessage);
        document.getElementById('chat-input').addEventListener('keypress',e=>{if(e.key==='Enter')sendChatMessage()});
        document.addEventListener('keydown',e=>{if(e.key==='Escape'&&document.getElementById('task-drawer').classList.contains('open'))closeTaskDrawer()});
        window.addEventListener('DOMContentLoaded',()=>{loadLiveEvents();setInterval(loadLiveEvents,3000)});
    </script>
</body>
</html>
