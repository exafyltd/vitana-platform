name: OASIS Persistence CI
# VTID: DEV-CICDL-2025-0001
# Purpose: CI for OASIS persistence layer and Gateway Service Tests
# Last updated: 2025-12-18 - Added env var injection for SUPABASE and GOOGLE_GEMINI_API_KEY

on:
  pull_request:
    paths:
      - 'prisma/**'
      - 'database/**'
      - 'services/gateway/**'
      - 'scripts/report.sh'
      - '.github/workflows/oasis-persistence.yml'
      - '.github/workflows/OASIS-PERSISTENCE.yml'
  push:
    branches:
      - main
    paths:
      - 'prisma/**'
      - 'database/**'
      - 'services/gateway/**'
      - 'scripts/report.sh'

jobs:
  prisma-check:
    name: Prisma Schema Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm prisma generate
      - run: pnpm prisma format --check

  gateway-test:
    name: Gateway Service Tests
    runs-on: ubuntu-latest
    # DEV-CICDL-2025-0001: Inject all required secrets at job level for gateway tests
    env:
      NODE_ENV: test
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      # DEV-CICDL-2025-0001: Preflight check - fail fast if required env vars are missing
      - name: Preflight - Validate Required Env Vars
        run: |
          echo "üîç Checking required environment variables..."
          MISSING=""
          test -n "$SUPABASE_URL" || MISSING="${MISSING} SUPABASE_URL"
          test -n "$SUPABASE_SERVICE_ROLE" || MISSING="${MISSING} SUPABASE_SERVICE_ROLE"
          test -n "$GOOGLE_GEMINI_API_KEY" || MISSING="${MISSING} GOOGLE_GEMINI_API_KEY"
          if [ -n "$MISSING" ]; then
            echo "‚ùå Missing required environment variables:${MISSING}"
            echo "Please ensure these secrets are configured in GitHub repository settings."
            exit 1
          fi
          echo "‚úÖ All required environment variables are set"

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./services/gateway
        run: npm install

      - name: Type check
        working-directory: ./services/gateway
        run: npm run typecheck

      - name: Run tests
        working-directory: ./services/gateway
        run: npm test

      - name: Build
        working-directory: ./services/gateway
        run: npm run build

  reporter-test:
    name: Reporter Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: bash -n scripts/report.sh
      - run: echo "‚úÖ Script syntax valid"
