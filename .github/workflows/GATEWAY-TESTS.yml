name: Gateway Service Tests
on:
  pull_request:
    branches: [main, trunk, develop, release/**]
    paths:
      - 'services/gateway/**'
      - 'prisma/**'
      - '.github/workflows/GATEWAY-TESTS.yml'
  push:
    branches: [main, trunk]
    paths:
      - 'services/gateway/**'
      - 'prisma/**'

jobs:
  gateway-tests:
    name: Gateway Service Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vitana_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vitana_test?schema=public
      SUPABASE_URL: http://localhost:54321
      SUPABASE_SERVICE_ROLE: test-service-role-key-mock
      NODE_ENV: test
      VTID: DEV-CICDL-0034
      VT_LAYER: CICDL
      VT_MODULE: GATEWAY
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Prisma CLI globally
        run: npm install -g prisma
      
      - name: Generate Prisma Client
        run: |
          echo "🔧 Generating Prisma client..."
          cd prisma
          prisma generate
      
      - name: Run Prisma migrations
        run: |
          echo "🗄️  Running Prisma migrations..."
          cd prisma
          prisma migrate deploy || prisma db push --skip-generate
      
      - name: Install Gateway dependencies
        run: |
          echo "📦 Installing Gateway dependencies..."
          cd services/gateway
          npm ci || npm install
          echo "✅ Dependencies installed"
          echo "📋 Checking test files..."
          ls -la test/
          echo "📋 Checking __mocks__..."
          ls -la test/__mocks__/ || echo "⚠️  No __mocks__ directory"
      
      - name: Run Gateway tests
        run: |
          echo "🧪 Running Gateway service tests..."
          cd services/gateway
          echo "Environment:"
          echo "  DATABASE_URL: $DATABASE_URL"
          echo "  SUPABASE_URL: $SUPABASE_URL"
          echo "  NODE_ENV: $NODE_ENV"
          npm test -- --verbose
      
      - name: Summary
        if: always()
        run: |
          echo "## Gateway Tests Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Prisma client generated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Database migrations applied" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Gateway dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Gateway tests executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** GitHub Actions with Postgres 16 service container" >> $GITHUB_STEP_SUMMARY
          echo "**Mock Setup:** Supabase/OASIS calls mocked for isolated testing" >> $GITHUB_STEP_SUMMARY
          echo "**VTID:** DEV-CICDL-0034" >> $GITHUB_STEP_SUMMARY

  prisma-check:
    name: Prisma Schema Check
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vitana_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vitana_test?schema=public
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Prisma CLI
        run: npm install -g prisma
      
      - name: Validate Prisma schema
        run: |
          echo "✅ Validating Prisma schema..."
          cd prisma
          prisma validate
      
      - name: Generate Prisma client (verification)
        run: |
          echo "🔧 Generating Prisma client to verify schema..."
          cd prisma
          prisma generate
      
      - name: Format check
        run: |
          echo "📝 Checking Prisma format..."
          cd prisma
          prisma format --check || echo "⚠️ Format check skipped (non-critical)"
      
      - name: Summary
        if: always()
        run: |
          echo "## Prisma Schema Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Schema validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Client generation verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VTID:** DEV-CICDL-0034" >> $GITHUB_STEP_SUMMARY
