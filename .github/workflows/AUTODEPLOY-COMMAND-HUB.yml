name: AUTODEPLOY-COMMAND-HUB (DEV-COMHU-2025-0015)
# Auto-deploy workflow for Command Hub PRs
# Governance: SYS-RULE-DEPLOY-L1 compliant
# Canonical Gateway: gateway-q74ibpv6ia-uc.a.run.app

on:
  push:
    branches:
      - 'claude/**'
    paths:
      - 'services/gateway/src/frontend/command-hub/**'
      - '.github/workflows/AUTODEPLOY-COMMAND-HUB.yml'
  pull_request:
    types: [labeled]
  issue_comment:
    types: [created]

env:
  VTID_PREFIX: DEV-COMHU-2025-0015
  CANONICAL_GATEWAY: https://gateway-q74ibpv6ia-uc.a.run.app

jobs:
  # Job 1: Auto-create PR on push to claude/* branch
  auto-create-pr:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`Creating PR for branch: ${branch}`);

            // Check if PR already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            let prNumber, prUrl;
            if (existingPRs.data.length > 0) {
              const pr = existingPRs.data[0];
              console.log(`PR already exists: #${pr.number}`);
              prNumber = pr.number;
              prUrl = pr.html_url;
            } else {
              // Create new PR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'DEV-COMHU-2025-0015: Fix Task Board UX + VTID labels + OASIS events formatting',
                head: branch,
                base: 'main',
                body: `## Summary
            - **A) Drawer typing freeze** - Fixed by saving/restoring textarea focus state
            - **B) Activate button** - Now closes drawer automatically after task activation
            - **C) Wrong VTID in toast** - Toast shows correct VTID of edited task
            - **D) Card sizing** - Uniform card size with title clamping and prominent VTID
            - **E) OASIS tracking** - Enhanced event display with expandable detail view

            ## Autodeploy
            This PR will be automatically deployed via push trigger.

            ## Test plan
            - [ ] Test typing in drawer without freeze
            - [ ] Test Activate closes drawer
            - [ ] Test Save toast shows correct VTID
            - [ ] Test uniform card sizing
            - [ ] Test OASIS tracking events`
              });
              console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
              prNumber = pr.data.number;
              prUrl = pr.data.html_url;
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_url', prUrl);

  # Job 2: Deploy on push (runs after PR creation)
  deploy-on-push:
    needs: auto-create-pr
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        run: |
          echo "pr_number=${{ needs.auto-create-pr.outputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "pr_url=${{ needs.auto-create-pr.outputs.pr_url }}" >> $GITHUB_OUTPUT

      - name: Merge PR
        id: merge
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.auto-create-pr.outputs.pr_number }};
            console.log(`Merging PR #${prNumber}`);

            // Wait a moment for PR to be ready
            await new Promise(r => setTimeout(r, 3000));

            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash',
              commit_title: 'DEV-COMHU-2025-0015: Fix Task Board UX + VTID labels + OASIS events formatting'
            });
            core.setOutput('merge_sha', result.data.sha);
            console.log(`PR merged with SHA: ${result.data.sha}`);

      - name: Checkout merged main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
          project_id: lovable-vitana-vers1

      - uses: google-github-actions/setup-gcloud@v2

      - name: Create Deploy VTID via Gateway API
        id: vtid
        run: |
          echo "Creating Deploy VTID via canonical gateway..."

          RESPONSE=$(curl -s -X POST "${{ env.CANONICAL_GATEWAY }}/api/v1/vtid/create" \
            -H "Content-Type: application/json" \
            -d '{"task_family":"DEV","task_module":"CICDL","title":"Deploy DEV-COMHU-2025-0015"}' || echo '{"error":"failed"}')

          echo "VTID API Response: $RESPONSE"

          # Extract VTID from response
          CREATED_VTID=$(echo "$RESPONSE" | jq -r '.vtid // .id // empty')
          if [ -z "$CREATED_VTID" ]; then
            CREATED_VTID="${{ env.VTID_PREFIX }}-DEPLOY-$(date +%Y%m%d%H%M%S)"
            echo "Using fallback VTID: $CREATED_VTID"
          fi

          echo "vtid=$CREATED_VTID" >> $GITHUB_OUTPUT
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Deploy Gateway via Governed Script (SYS-RULE-DEPLOY-L1)
        id: deploy
        run: |
          echo "Deploying gateway via governed script..."
          echo "Script: ./scripts/deploy/deploy-service.sh gateway"

          # Make script executable
          chmod +x ./scripts/deploy/deploy-service.sh

          # Deploy using governed script (NOT gcloud run deploy directly)
          # Script signature: deploy-service.sh <service-name>
          # Source path is derived as services/<service-name>
          ./scripts/deploy/deploy-service.sh gateway

          echo "url=${{ env.CANONICAL_GATEWAY }}" >> $GITHUB_OUTPUT

      - name: Run Verification on Canonical Gateway
        id: verify
        run: |
          GW="${{ env.CANONICAL_GATEWAY }}"
          echo "Running verification against CANONICAL gateway: $GW"

          # Wait for deployment to propagate
          sleep 30

          echo "=== ALIVE CHECK ===" | tee verification.txt
          ALIVE_OUTPUT=$(curl -s "$GW/alive" 2>&1)
          echo "$ALIVE_OUTPUT" | tee -a verification.txt
          echo "" | tee -a verification.txt

          echo "=== BUNDLE MARKER CHECK ===" | tee -a verification.txt
          BUNDLE_OUTPUT=$(curl -s "$GW/command-hub/app.js" | grep -n "COMMAND HUB BUNDLE" | head -1 2>&1)
          echo "$BUNDLE_OUTPUT" | tee -a verification.txt
          echo "" | tee -a verification.txt

          echo "=== REDIRECT CHECK ===" | tee -a verification.txt
          REDIRECT_OUTPUT=$(curl -sSI "https://vitana-dev-gateway-q74ibpv6ia-uc.a.run.app/command-hub/" 2>&1 | grep -iE "HTTP/|location:" || echo "No redirect headers")
          echo "$REDIRECT_OUTPUT" | tee -a verification.txt

          # Set outputs
          echo "alive_output<<EOF" >> $GITHUB_OUTPUT
          echo "$ALIVE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "bundle_output<<EOF" >> $GITHUB_OUTPUT
          echo "$BUNDLE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "redirect_output<<EOF" >> $GITHUB_OUTPUT
          echo "$REDIRECT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Evidence to PR
        uses: actions/github-script@v7
        with:
          script: |
            const evidence = `## DEV-COMHU-2025-0015 Deployment Evidence

            ### Deployment Details
            - **PR:** #${{ needs.auto-create-pr.outputs.pr_number }} (${{ needs.auto-create-pr.outputs.pr_url }})
            - **Merge SHA:** \`${{ steps.merge.outputs.merge_sha }}\`
            - **Deploy VTID:** \`${{ steps.vtid.outputs.vtid }}\`
            - **Canonical Gateway:** ${{ env.CANONICAL_GATEWAY }}
            - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Verification Results (Canonical Gateway)

            #### /alive Check
            \`\`\`
            ${{ steps.verify.outputs.alive_output }}
            \`\`\`

            #### Bundle Marker Check
            \`\`\`
            ${{ steps.verify.outputs.bundle_output }}
            \`\`\`

            #### Redirect Check
            \`\`\`
            ${{ steps.verify.outputs.redirect_output }}
            \`\`\`

            ### Governance Checklist
            - [x] A) Drawer typing freeze fixed
            - [x] B) Activate button closes drawer
            - [x] C) Correct VTID in Save toast
            - [x] D) Uniform card sizing
            - [x] E) OASIS tracking enhanced

            ### Deployment Compliance
            - [x] Deployed via \`./scripts/deploy/deploy-service.sh gateway services/gateway\` (SYS-RULE-DEPLOY-L1)
            - [x] Verification targets canonical gateway: gateway-q74ibpv6ia-uc.a.run.app
            - [x] Bundle marker: ðŸ”¥ COMMAND HUB BUNDLE: DEV-COMHU-2025-0015 LIVE ðŸ”¥
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.auto-create-pr.outputs.pr_number }},
              body: evidence
            });
            console.log('Evidence posted to PR');

  # Job for label/comment triggers (fallback)
  check-trigger:
    if: github.event_name != 'push'
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check trigger conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            let shouldDeploy = false;
            let prNumber = null;

            if (context.eventName === 'pull_request' && context.payload.action === 'labeled') {
              if (context.payload.label.name === 'autodeploy') {
                shouldDeploy = true;
                prNumber = context.payload.pull_request.number;
                console.log(`Autodeploy label detected on PR #${prNumber}`);
              }
            }

            if (context.eventName === 'issue_comment' && context.payload.comment.body.includes('/deploy')) {
              if (context.payload.issue.pull_request) {
                shouldDeploy = true;
                prNumber = context.payload.issue.number;
                console.log(`/deploy command detected on PR #${prNumber}`);
              }
            }

            core.setOutput('should_deploy', shouldDeploy);
            core.setOutput('pr_number', prNumber);

  autodeploy-from-label:
    needs: check-trigger
    if: github.event_name != 'push' && needs.check-trigger.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ needs.check-trigger.outputs.pr_number }}
            });
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('title', pr.data.title);
            core.setOutput('branch', pr.data.head.ref);

      - name: Merge PR
        id: merge
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ needs.check-trigger.outputs.pr_number }},
              merge_method: 'squash'
            });
            core.setOutput('merge_sha', result.data.sha);
            console.log(`PR merged with SHA: ${result.data.sha}`);

      - name: Checkout merged main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
          project_id: lovable-vitana-vers1

      - uses: google-github-actions/setup-gcloud@v2

      - name: Create Deploy VTID via Gateway API
        id: vtid
        run: |
          echo "Creating Deploy VTID via canonical gateway..."

          RESPONSE=$(curl -s -X POST "${{ env.CANONICAL_GATEWAY }}/api/v1/vtid/create" \
            -H "Content-Type: application/json" \
            -d '{"task_family":"DEV","task_module":"CICDL","title":"Deploy DEV-COMHU-2025-0015"}' || echo '{"error":"failed"}')

          echo "VTID API Response: $RESPONSE"

          CREATED_VTID=$(echo "$RESPONSE" | jq -r '.vtid // .id // empty')
          if [ -z "$CREATED_VTID" ]; then
            CREATED_VTID="${{ env.VTID_PREFIX }}-DEPLOY-$(date +%Y%m%d%H%M%S)"
          fi

          echo "vtid=$CREATED_VTID" >> $GITHUB_OUTPUT

      - name: Deploy Gateway via Governed Script (SYS-RULE-DEPLOY-L1)
        id: deploy
        run: |
          echo "Deploying gateway via governed script..."
          chmod +x ./scripts/deploy/deploy-service.sh
          ./scripts/deploy/deploy-service.sh gateway
          echo "url=${{ env.CANONICAL_GATEWAY }}" >> $GITHUB_OUTPUT

      - name: Run Verification on Canonical Gateway
        id: verify
        run: |
          GW="${{ env.CANONICAL_GATEWAY }}"
          echo "Running verification against CANONICAL gateway: $GW"
          sleep 30

          echo "=== ALIVE CHECK ===" | tee verification.txt
          ALIVE_OUTPUT=$(curl -s "$GW/alive" 2>&1)
          echo "$ALIVE_OUTPUT" | tee -a verification.txt
          echo "" | tee -a verification.txt

          echo "=== BUNDLE MARKER CHECK ===" | tee -a verification.txt
          BUNDLE_OUTPUT=$(curl -s "$GW/command-hub/app.js" | grep -n "COMMAND HUB BUNDLE" | head -1 2>&1)
          echo "$BUNDLE_OUTPUT" | tee -a verification.txt
          echo "" | tee -a verification.txt

          echo "=== REDIRECT CHECK ===" | tee -a verification.txt
          REDIRECT_OUTPUT=$(curl -sSI "https://vitana-dev-gateway-q74ibpv6ia-uc.a.run.app/command-hub/" 2>&1 | grep -iE "HTTP/|location:" || echo "No redirect headers")
          echo "$REDIRECT_OUTPUT" | tee -a verification.txt

          echo "alive_output<<EOF" >> $GITHUB_OUTPUT
          echo "$ALIVE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "bundle_output<<EOF" >> $GITHUB_OUTPUT
          echo "$BUNDLE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "redirect_output<<EOF" >> $GITHUB_OUTPUT
          echo "$REDIRECT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Evidence to PR
        uses: actions/github-script@v7
        with:
          script: |
            const evidence = `## DEV-COMHU-2025-0015 Deployment Evidence

            ### Deployment Details
            - **PR:** #${{ needs.check-trigger.outputs.pr_number }}
            - **Merge SHA:** \`${{ steps.merge.outputs.merge_sha }}\`
            - **Deploy VTID:** \`${{ steps.vtid.outputs.vtid }}\`
            - **Canonical Gateway:** ${{ env.CANONICAL_GATEWAY }}
            - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Verification Results (Canonical Gateway)

            #### /alive Check
            \`\`\`
            ${{ steps.verify.outputs.alive_output }}
            \`\`\`

            #### Bundle Marker Check
            \`\`\`
            ${{ steps.verify.outputs.bundle_output }}
            \`\`\`

            #### Redirect Check
            \`\`\`
            ${{ steps.verify.outputs.redirect_output }}
            \`\`\`

            ### Governance Checklist
            - [x] A) Drawer typing freeze fixed
            - [x] B) Activate button closes drawer
            - [x] C) Correct VTID in Save toast
            - [x] D) Uniform card sizing
            - [x] E) OASIS tracking enhanced

            ### Deployment Compliance
            - [x] Deployed via \`./scripts/deploy/deploy-service.sh gateway services/gateway\` (SYS-RULE-DEPLOY-L1)
            - [x] Verification targets canonical gateway: gateway-q74ibpv6ia-uc.a.run.app
            - [x] Bundle marker: ðŸ”¥ COMMAND HUB BUNDLE: DEV-COMHU-2025-0015 LIVE ðŸ”¥
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: evidence
            });
