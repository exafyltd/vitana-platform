name: AUTODEPLOY-COMMAND-HUB (DEV-COMHU-2025-0015)
# Governance: SYS-RULE-DEPLOY-L1 compliant
# Canonical Gateway: gateway-q74ibpv6ia-uc.a.run.app

on:
  push:
    branches:
      - main
    paths:
      - 'services/gateway/src/frontend/command-hub/**'
      - 'services/gateway/dist/frontend/command-hub/**'
  workflow_dispatch:

env:
  VTID_PREFIX: DEV-COMHU-2025-0015
  GW: https://gateway-q74ibpv6ia-uc.a.run.app
  GCP_PROJECT: lovable-vitana-vers1
  GCP_REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Validate Secrets (Fail Fast)
        run: |
          MISSING=""
          if [ -z "${{ secrets.GCP_WIF_PROVIDER }}" ]; then MISSING="$MISSING GCP_WIF_PROVIDER"; fi
          if [ -z "${{ secrets.GCP_WIF_SA_EMAIL }}" ]; then MISSING="$MISSING GCP_WIF_SA_EMAIL"; fi
          if [ -n "$MISSING" ]; then
            echo "::error::MISSING SECRETS:$MISSING"
            echo "Admin must add: GCP_WIF_PROVIDER, GCP_WIF_SA_EMAIL"
            echo "And grant WIF service account: roles/run.admin, roles/cloudbuild.builds.builder, roles/artifactregistry.writer"
            echo "And add workload identity binding: roles/iam.workloadIdentityUser"
            exit 1
          fi

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Auth GCP (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
          project_id: ${{ env.GCP_PROJECT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Get SHA
        id: sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Create Deploy VTID
        id: vtid
        run: |
          RESP=$(curl -s -X POST "${{ env.GW }}/api/v1/vtid/create" \
            -H "Content-Type: application/json" \
            -d '{"task_family":"DEV","task_module":"CICDL","title":"Deploy DEV-COMHU-2025-0015"}' || echo '{}')
          echo "Response: $RESP"
          VID=$(echo "$RESP" | jq -r '.vtid // .id // empty')
          [ -z "$VID" ] && VID="${{ env.VTID_PREFIX }}-DEPLOY-$(date +%Y%m%d%H%M%S)"
          echo "vtid=$VID" >> $GITHUB_OUTPUT

      - name: Deploy (SYS-RULE-DEPLOY-L1)
        run: |
          chmod +x ./scripts/deploy/deploy-service.sh
          ./scripts/deploy/deploy-service.sh gateway services/gateway

      - name: Wait
        run: sleep 60

      - name: Verify
        id: verify
        run: |
          echo "=== curl -s \$GW/alive ===" > out.txt
          curl -s "${{ env.GW }}/alive" >> out.txt
          echo "" >> out.txt
          echo '=== curl -s "$GW/command-hub/app.js" | grep -n "COMMAND HUB BUNDLE" ===' >> out.txt
          curl -s "${{ env.GW }}/command-hub/app.js" | grep -n "COMMAND HUB BUNDLE" | head -1 >> out.txt
          echo "" >> out.txt
          echo '=== curl -sSI "vitana-dev-gateway.../command-hub/" | egrep -i "HTTP/|location:" ===' >> out.txt
          curl -sSI "https://vitana-dev-gateway-q74ibpv6ia-uc.a.run.app/command-hub/" | grep -iE "HTTP/|location:" >> out.txt || true
          cat out.txt
          echo "output<<EOF" >> $GITHUB_OUTPUT
          cat out.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Evidence
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## DEV-COMHU-2025-0015 Deployment Evidence

**Merge SHA:** \`${{ steps.sha.outputs.sha }}\`
**Deploy VTID:** \`${{ steps.vtid.outputs.vtid }}\`
**Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
**Status:** ${{ job.status }}

### Curl Outputs
\`\`\`
${{ steps.verify.outputs.output }}
\`\`\`

### Bundle Marker
Expected: \`ðŸ”¥ COMMAND HUB BUNDLE: DEV-COMHU-2025-0015 LIVE ðŸ”¥\`

### Compliance
- [x] SYS-RULE-DEPLOY-L1: ./scripts/deploy/deploy-service.sh gateway services/gateway
- [x] Canonical target: gateway-q74ibpv6ia-uc.a.run.app
`;
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'autodeploy-evidence',
              state: 'open'
            });
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[EVIDENCE] DEV-COMHU-2025-0015',
                body: body,
                labels: ['autodeploy-evidence']
              });
            }
