name: Command Hub Guardrails (VTID-0302)
# VTID-0302: Command Hub Golden Shield & Regression Guard
#
# This workflow enforces three critical guardrails:
# 1. Path Ownership Guard - Only DEV-COMHU-* VTIDs may modify Command Hub frontend
# 2. Golden Fingerprint Check - Ensures the bundle contains all required markers
# 3. Bundle Syntax Gate (VTID-01011) - Blocks deploy if app.js has JS parse errors

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/gateway/src/frontend/command-hub/**'
      - 'services/gateway/dist/frontend/command-hub/**'
  push:
    branches: [main]
    paths:
      - 'services/gateway/src/frontend/command-hub/**'

env:
  NODE_VERSION: '20.x'

jobs:
  path-ownership-guard:
    name: Path Ownership Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Command Hub Path Ownership
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: node scripts/ci/command-hub-ownership-guard.js

  golden-fingerprint-check:
    name: Golden Fingerprint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: services/gateway
        run: npm ci

      - name: Build gateway
        working-directory: services/gateway
        run: npm run build

      - name: Verify Golden Fingerprint
        run: node scripts/ci/command-hub-golden-fingerprint.js

  bundle-syntax-gate:
    name: Bundle Syntax Gate (VTID-01011)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: services/gateway
        run: npm ci

      - name: Build gateway
        working-directory: services/gateway
        run: npm run build

      - name: Command Hub Bundle Syntax Check
        run: |
          echo "üîç VTID-01011: Command Hub Bundle Syntax Gate"
          echo "============================================="
          echo ""
          FAILED=0

          # Check dist bundle (required - this is what gets deployed)
          echo "üì¶ Checking dist bundle: services/gateway/dist/frontend/command-hub/app.js"
          if node --check services/gateway/dist/frontend/command-hub/app.js 2>&1; then
            echo "‚úÖ dist/frontend/command-hub/app.js: VALID JavaScript syntax"
          else
            echo "‚ùå dist/frontend/command-hub/app.js: SYNTAX ERROR DETECTED"
            FAILED=1
          fi
          echo ""

          # Check src bundle (if present)
          if [ -f "services/gateway/src/frontend/command-hub/app.js" ]; then
            echo "üìÑ Checking src bundle: services/gateway/src/frontend/command-hub/app.js"
            if node --check services/gateway/src/frontend/command-hub/app.js 2>&1; then
              echo "‚úÖ src/frontend/command-hub/app.js: VALID JavaScript syntax"
            else
              echo "‚ùå src/frontend/command-hub/app.js: SYNTAX ERROR DETECTED"
              FAILED=1
            fi
            echo ""
          fi

          # Final verdict
          echo "============================================="
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå VTID-01011: Bundle Syntax Gate FAILED"
            echo "   JavaScript parse errors detected - PR blocked"
            exit 1
          else
            echo "‚úÖ VTID-01011: Bundle Syntax Gate PASSED"
            echo "   All Command Hub bundles have valid JavaScript syntax"
          fi
