name: Command Hub Guardrails (VTID-0302)
# VTID-0302: Command Hub Golden Shield & Regression Guard
#
# This workflow enforces two critical guardrails:
# 1. Path Ownership Guard - Only DEV-COMHU-* VTIDs may modify Command Hub frontend
# 2. Golden Fingerprint Check - Ensures the bundle contains all required markers

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/gateway/src/frontend/command-hub/**'
      - 'services/gateway/dist/frontend/command-hub/**'
  push:
    branches: [main]
    paths:
      - 'services/gateway/src/frontend/command-hub/**'

env:
  NODE_VERSION: '20.x'

jobs:
  path-ownership-guard:
    name: Path Ownership Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Command Hub Path Ownership
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: node scripts/ci/command-hub-ownership-guard.js

  golden-fingerprint-check:
    name: Golden Fingerprint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: services/gateway
        run: npm ci

      - name: Build gateway
        working-directory: services/gateway
        run: npm run build

      - name: Verify Golden Fingerprint
        run: node scripts/ci/command-hub-golden-fingerprint.js
