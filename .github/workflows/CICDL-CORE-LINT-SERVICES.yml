name: CICDL-CORE-LINT-SERVICES

on:
  pull_request:
    branches: [main, trunk, develop, release/**]
    paths:
      - 'services/**'
  push:
    branches: [main, trunk]
    paths:
      - 'services/**'

run-name: 'Services Lint [VTID: DEV-CICDL-0033] (${{ github.ref_name }})'

jobs:
  lint-services:
    name: Validate Services Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check services directory structure
        run: |
          echo "üîç Validating services directory structure..."
          
          violations=0
          
          if [ ! -d "services" ]; then
            echo "‚ùå ERROR: /services directory not found"
            exit 1
          fi
          
          echo "‚úÖ /services directory exists"
          echo ""
          
          echo "üìã Found services:"
          find services -mindepth 1 -maxdepth 3 -type d | sort
          echo ""
      
      - name: Validate manifest.json presence
        run: |
          echo "üîç Checking for manifest.json in each service..."
          echo ""
          
          violations=0
          services_checked=0
          
          # Check agents - look for manifest.json at the direct agent level
          for agent_dir in services/agents/*/; do
            if [ -d "$agent_dir" ]; then
              services_checked=$((services_checked + 1))
              agent_name=$(basename "$agent_dir")
              
              if [ -f "${agent_dir}manifest.json" ]; then
                echo "‚úÖ ${agent_dir}"
              else
                echo "‚ùå Missing: ${agent_dir}manifest.json"
                violations=$((violations + 1))
              fi
            fi
          done
          
          # Check MCP services
          for mcp_dir in services/mcp/*/; do
            if [ -d "$mcp_dir" ]; then
              services_checked=$((services_checked + 1))
              
              if [ -f "${mcp_dir}manifest.json" ]; then
                echo "‚úÖ $mcp_dir"
              else
                echo "‚ùå Missing: ${mcp_dir}manifest.json"
                violations=$((violations + 1))
              fi
            fi
          done
          
          # Check gateway
          if [ -d "services/gateway" ]; then
            services_checked=$((services_checked + 1))
            
            if [ -f "services/gateway/manifest.json" ]; then
              echo "‚úÖ services/gateway/"
            else
              echo "‚ùå Missing: services/gateway/manifest.json"
              violations=$((violations + 1))
            fi
          fi
          
          # Check deploy-watcher
          if [ -d "services/deploy-watcher" ]; then
            services_checked=$((services_checked + 1))
            
            if [ -f "services/deploy-watcher/manifest.json" ]; then
              echo "‚úÖ services/deploy-watcher/"
            else
              echo "‚ùå Missing: services/deploy-watcher/manifest.json"
              violations=$((violations + 1))
            fi
          fi
          
          echo ""
          echo "Services checked: $services_checked"
          echo "Violations: $violations"
          
          if [ $violations -gt 0 ]; then
            echo ""
            echo "‚ùå FAILURE: $violations service(s) missing manifest.json"
            exit 1
          fi
          
          echo "‚úÖ All services have manifest.json files"
      
      - name: Validate manifest.json schema
        run: |
          echo "üîç Validating manifest.json schema..."
          echo ""
          
          violations=0
          manifests=$(find services -maxdepth 3 -name "manifest.json" -type f)
          
          if [ -z "$manifests" ]; then
            echo "‚ö†Ô∏è  No manifest.json files found"
            exit 0
          fi
          
          for manifest in $manifests; do
            echo "Checking: $manifest"
            
            if ! jq empty "$manifest" 2>/dev/null; then
              echo "  ‚ùå Invalid JSON syntax"
              violations=$((violations + 1))
              continue
            fi
            
            # Check for required fields - support both old and new schema
            name=$(jq -r '.name // empty' "$manifest")
            vtid=$(jq -r '.vtid // empty' "$manifest")
            vt_layer=$(jq -r '.vt_layer // .layer // empty' "$manifest")
            vt_module=$(jq -r '.vt_module // .module // empty' "$manifest")
            
            if [ -z "$name" ]; then
              echo "  ‚ùå Missing required field: name"
              violations=$((violations + 1))
            fi
            
            # Either vtid or both vt_layer/vt_module required
            if [ -z "$vtid" ] && ([ -z "$vt_layer" ] || [ -z "$vt_module" ]); then
              echo "  ‚ö†Ô∏è  Warning: Missing vtid or vt_layer/vt_module"
            fi
            
            if [ $violations -eq 0 ]; then
              echo "  ‚úÖ Valid: $name"
            fi
          done
          
          echo ""
          
          if [ $violations -gt 0 ]; then
            echo "‚ùå FAILURE: $violations manifest validation error(s)"
            exit 1
          fi
          
          echo "‚úÖ All manifests are valid"
      
      - name: Check naming conventions
        run: |
          echo "üîç Checking top-level service naming conventions..."
          echo ""
          
          violations=0
          
          # Only check top-level service directories (maxdepth 2)
          # Internal subdirectories can follow language conventions (e.g., Python snake_case)
          while IFS= read -r dir; do
            dirname=$(basename "$dir")
            
            # Skip hidden directories and node_modules
            if [[ "$dirname" == .* ]] || [[ "$dirname" == "node_modules" ]]; then
              continue
            fi
            
            # Check for uppercase or underscore
            if echo "$dirname" | grep -qE '[A-Z]|_'; then
              echo "‚ùå Non-kebab-case directory: $dir"
              echo "   Top-level service directories must use kebab-case"
              violations=$((violations + 1))
            fi
          done < <(find services -mindepth 1 -maxdepth 2 -type d -not -path "*/node_modules/*")
          
          if [ $violations -gt 0 ]; then
            echo ""
            echo "‚ùå FAILURE: $violations naming convention violation(s)"
            echo ""
            echo "üìò Phase 2B Standard: Top-level service directories must use kebab-case"
            echo "   Internal subdirectories may follow language conventions"
            exit 1
          fi
          
          echo "‚úÖ All top-level service directories follow kebab-case convention"
      
      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Services Lint Checks Complete"
          echo ""
          echo "Checks passed:"
          echo "  ‚úÖ Services directory structure valid"
          echo "  ‚úÖ All services have manifest.json"
          echo "  ‚úÖ All manifests have valid schema"
          echo "  ‚úÖ Naming conventions followed"
