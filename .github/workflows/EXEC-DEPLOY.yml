name: Exec Deploy (VTID Bridge)
on:
  workflow_dispatch:
    inputs:
      vtid:
        description: 'VTID'
        required: true
      service:
        description: 'Service name'
        required: true
        default: 'vitana-gateway'
      image:
        description: 'Container image'
        required: true
      health_path:
        description: 'Health path'
        required: true
        default: '/alive'
      initiator:
        description: 'Initiator (user or agent)'
        required: false
        default: 'agent'
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
          project_id: lovable-vitana-vers1
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy "${{ github.event.inputs.service }}" --image="${{ github.event.inputs.image }}" --region=us-central1 --project=lovable-vitana-vers1 --allow-unauthenticated
          URL=$(gcloud run services describe ${{ github.event.inputs.service }} --region=us-central1 --format='value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT
          curl -fsS "$URL${{ github.event.inputs.health_path }}" -H "X-VTID: ${{ github.event.inputs.vtid }}"
      - name: Record Software Version (VTID-0510)
        if: success()
        env:
          GATEWAY_URL: ${{ steps.deploy.outputs.service_url }}
        run: |
          # Record deployment version in OASIS via Gateway API
          # Extract service name (remove prefix if present)
          SERVICE_NAME="${{ github.event.inputs.service }}"
          SERVICE_NAME="${SERVICE_NAME#vitana-}"

          # Get git commit SHA
          GIT_COMMIT="${{ github.sha }}"

          # Call operator API to record deployment
          curl -fsS "${GATEWAY_URL}/api/v1/operator/deployments" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-VTID: ${{ github.event.inputs.vtid }}" \
            -d "{\"service\":\"${SERVICE_NAME}\",\"git_commit\":\"${GIT_COMMIT}\",\"deploy_type\":\"normal\",\"initiator\":\"${{ github.event.inputs.initiator }}\",\"environment\":\"dev-sandbox\"}" \
            || echo "Warning: Failed to record version (non-fatal)"
