# ============================================================================
# DISABLED by VTID-01170 - Operational Safety Lock
# ============================================================================
# DEPRECATED — DO NOT USE
# Canonical deployment is:
#   main → .github/workflows/AUTO-DEPLOY.yml → dispatches EXEC-DEPLOY.yml
#
# This workflow was previously MANUAL-ONLY (break-glass) but is now fully
# DISABLED to enforce single-spine deployment.
#
# DO NOT RE-ENABLE without governance approval.
# See: VTID-01170 (Freeze Parallel Paths)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      confirm_bypass:
        description: 'Type EMERGENCY-BYPASS to run (governance violation)'
        required: true
        type: string

name: Deploy MCP Gateway

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # VTID-01170: Hard block - this workflow is disabled
      - name: "[VTID-01170] WORKFLOW DISABLED - Canonical Spine Enforcement"
        run: |
          echo "============================================================"
          echo "  ⛔ WORKFLOW DISABLED by VTID-01170"
          echo "============================================================"
          echo ""
          echo "  This workflow (DEPLOY-MCP-GATEWAY) is DEPRECATED and DISABLED."
          echo "  Canonical deployment path: AUTO-DEPLOY.yml -> EXEC-DEPLOY.yml"
          echo ""
          echo "============================================================"
          if [ "${{ inputs.confirm_bypass }}" != "EMERGENCY-BYPASS" ]; then
            echo "::error::Workflow blocked. To bypass, enter EMERGENCY-BYPASS (governance violation)"
            exit 1
          fi
          echo "::warning::EMERGENCY BYPASS activated - this is a governance violation"

      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: services/mcp/gateway
        run: npm ci
      
      - name: Build TypeScript
        working-directory: services/mcp/gateway
        run: npm run build
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Deploy to Cloud Run
        working-directory: services/mcp/gateway
        run: |
          gcloud run deploy mcp-gateway \
            --source . \
            --region us-central1 \
            --project lovable-vitana-vers1 \
            --allow-unauthenticated \
            --set-env-vars ENVIRONMENT=dev \
            --set-secrets=GITHUB_MCP_TOKEN=github-token:latest,SUPABASE_URL=supabase-url:latest,SUPABASE_SERVICE_ROLE_KEY=supabase-key:latest,PERPLEXITY_API_KEY=perplexity-key:latest,LINEAR_API_KEY=linear-key:latest,CONTEXT7_API_KEY=context7-key:latest,TESTSPRITE_API_KEY=testsprite-key:latest,GATEWAY_URL=gateway-url:latest \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 2
      
      - name: Wait for service to be ready
        run: sleep 30
      
      - name: Verify deployment health
        run: |
          SERVICE_URL=$(gcloud run services describe mcp-gateway \
            --region us-central1 \
            --project lovable-vitana-vers1 \
            --format='value(status.url)')
          
          echo "MCP Gateway URL: $SERVICE_URL"
          
          echo "Testing basic health endpoint..."
          HEALTH_RESPONSE=$(curl -s $SERVICE_URL/health)
          echo "$HEALTH_RESPONSE"
          
          if ! echo "$HEALTH_RESPONSE" | grep -q '"status":"ok"'; then
            echo "❌ Health check failed"
            exit 1
          fi
          
          echo "✅ Basic health check passed"
      
      - name: Verify MCP connectors
        run: |
          SERVICE_URL=$(gcloud run services describe mcp-gateway \
            --region us-central1 \
            --project lovable-vitana-vers1 \
            --format='value(status.url)')
          
          echo "Testing MCP connectors health..."
          MCP_HEALTH=$(curl -s $SERVICE_URL/mcp/health)
          echo "$MCP_HEALTH"
          
          # Check if all 6 connectors are present
          CONNECTOR_COUNT=$(echo "$MCP_HEALTH" | grep -o '"name":' | wc -l)
          if [ "$CONNECTOR_COUNT" -ne 6 ]; then
            echo "❌ Expected 6 connectors, found $CONNECTOR_COUNT"
            exit 1
          fi
          
          # Check if any connector is misconfigured
          if echo "$MCP_HEALTH" | grep -q '"status":"misconfigured"'; then
            echo "⚠️ WARNING: Some connectors are misconfigured"
            echo "$MCP_HEALTH" | grep "misconfigured"
            exit 1
          fi
          
          # Check if any connector has error status
          if echo "$MCP_HEALTH" | grep -q '"status":"error"'; then
            echo "❌ ERROR: Some connectors have errors"
            echo "$MCP_HEALTH" | grep "error"
            exit 1
          fi
          
          echo "✅ All MCP connectors are healthy"
      
      - name: Test sample MCP call
        run: |
          SERVICE_URL=$(gcloud run services describe mcp-gateway \
            --region us-central1 \
            --project lovable-vitana-vers1 \
            --format='value(status.url)')
          
          fi
      
      - name: Deployment summary
        if: always()
        run: |
          SERVICE_URL=$(gcloud run services describe mcp-gateway \
            --region us-central1 \
            --project lovable-vitana-vers1 \
            --format='value(status.url)' 2>/dev/null || echo "unknown")
          
          echo "=========================================="
          echo "   MCP GATEWAY DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo ""
          echo "Service URL: $SERVICE_URL"
          echo "VTID: DEV-CICDL-0052"
          echo ""
          echo "Next: All PRs will run these tests automatically"
