name: Apply Supabase Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  apply-migrations:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Postgres Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils

      - name: Apply Migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          PGSSLMODE: require
        run: |
          # Mask the secret in logs just in case
          echo "::add-mask::$SUPABASE_DB_URL"
          
          # Debug: Check if secret is set
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "::error::SUPABASE_DB_URL secret is empty or not set!"
            exit 1
          fi
          
          # Extract hostname from the connection string
          # Assumes format: postgres://user:pass@hostname:port/db or similar
          # We use sed to extract the part between @ and : (port) or / (path)
          HOST=$(echo "$SUPABASE_DB_URL" | sed -E 's/.*@([^:/]+).*/\1/')
          
          echo "Resolving host: $HOST"
          
          # Resolve to IPv4
          IP=$(dig +short A "$HOST" | head -n 1)
          
          if [ -z "$IP" ]; then
            echo "::error::Could not resolve $HOST to an IPv4 address"
            exit 1
          fi
          
          echo "Resolved to IPv4: $IP"
          
          # Replace hostname with IP in the connection string
          # We use python for safer string replacement to avoid leaking secrets in sed command line
          export DATABASE_URL=$(python3 -c "import os; print(os.environ['SUPABASE_DB_URL'].replace('$HOST', '$IP'))")
          
          # Check if we can connect (allow output to see errors)
          echo "Checking database connection..."
          if ! psql -c "SELECT 1"; then
            echo "::error::Cannot connect to Supabase DB. Check SUPABASE_DB_URL secret and logs above."
            exit 1
          fi

          echo "Connected to Supabase. Applying migrations..."

          # Loop through all SQL files in sorted order
          for file in $(ls supabase/migrations/*.sql | sort); do
            echo "Processing $file..."
            
            # Apply the migration
            # ON_ERROR_STOP=1 ensures psql exits with error code if SQL fails
            psql -v ON_ERROR_STOP=1 -f "$file"
            
            if [ $? -eq 0 ]; then
              echo "✅ Successfully applied $file"
            else
              echo "::error::Failed to apply $file"
              exit 1
            fi
          done

      - name: Verify Migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          PGSSLMODE: require
        run: |
          # Resolve IP again for verification step
          HOST=$(echo "$SUPABASE_DB_URL" | sed -E 's/.*@([^:/]+).*/\1/')
          IP=$(dig +short A "$HOST" | head -n 1)
          export DATABASE_URL=$(python3 -c "import os; print(os.environ['SUPABASE_DB_URL'].replace('$HOST', '$IP'))")
          
          echo "Verifying governance tables..."
          
          # Verify oasis_events_v1 exists
          if psql -c "SELECT 1 FROM oasis_events_v1 LIMIT 1;" -t | grep -q 1; then
             echo "✅ Table oasis_events_v1 exists (or has data)"
          else
             # It might be empty but should exist. 
             # If table didn't exist, psql would error.
             # Let's check existence via information_schema to be sure
             COUNT=$(psql -t -c "SELECT count(*) FROM information_schema.tables WHERE table_name = 'oasis_events_v1';")
             if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
               echo "✅ Table oasis_events_v1 exists"
             else
               echo "::error::Table oasis_events_v1 missing!"
               exit 1
             fi
          fi

          # Verify governance_rules exists
          COUNT=$(psql -t -c "SELECT count(*) FROM information_schema.tables WHERE table_name = 'governance_rules';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Table governance_rules exists"
          else
            echo "::error::Table governance_rules missing!"
            exit 1
          fi

          # Verify MIGRATION_GOVERNANCE category exists (DEV-OASIS-GOV-0103)
          COUNT=$(psql -t -c "SELECT count(*) FROM governance_categories WHERE name = 'MIGRATION_GOVERNANCE';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Category MIGRATION_GOVERNANCE exists"
          else
            echo "::error::Category MIGRATION_GOVERNANCE missing!"
            exit 1
          fi

          # Verify MG-001 rule exists
          COUNT=$(psql -t -c "SELECT count(*) FROM governance_rules WHERE logic->>'rule_code' = 'MG-001';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Rule MG-001 exists"
          else
            echo "::error::Rule MG-001 missing!"
            exit 1
          fi

      - name: Log Success to OASIS
        if: success()
        env:
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          # Optional: Log to OASIS if Gateway URL is available
          if [ -n "$GATEWAY_URL" ]; then
            curl -X POST "$GATEWAY_URL/api/v1/events/ingest" \
              -H "Content-Type: application/json" \
              -d '{
                "vtid": "DEV-OASIS-GOV-0102",
                "type": "MIGRATION_APPLIED",
                "source": "github-actions",
                "status": "success",
                "message": "Governance migrations applied successfully"
              }' || true
          fi

      - name: Log Failure to OASIS
        if: failure()
        env:
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          if [ -n "$GATEWAY_URL" ]; then
            curl -X POST "$GATEWAY_URL/api/v1/events/ingest" \
              -H "Content-Type: application/json" \
              -d '{
                "vtid": "DEV-OASIS-GOV-0102",
                "type": "MIGRATION_FAILED",
                "source": "github-actions",
                "status": "error",
                "message": "Governance migrations failed - check GitHub Actions logs"
              }' || true
          fi
