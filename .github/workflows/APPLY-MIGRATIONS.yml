name: Apply Supabase Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  apply-migrations:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Postgres Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply Migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          PGSSLMODE: require
          PGCONNECT_TIMEOUT: 10
        run: |
          # Mask the secret in logs
          echo "::add-mask::$SUPABASE_DB_URL"
          
          # Check if secret is set
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "::error::SUPABASE_DB_URL secret is empty or not set!"
            exit 1
          fi
          
          # Try to connect using the DB_URL directly first (backward compatible)
          echo "Attempting connection to Supabase..."
          if psql "$SUPABASE_DB_URL" -c "SELECT 1" 2>&1 | grep -q "Network is unreachable"; then
            echo "IPv6 connection failed, attempting IPv4 workaround..."
            
            # Parse the connection string components
            # Format: postgres://user:pass@host:port/database
            PGUSER=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*://\([^:]*\):.*|\1|p')
            PGPASSWORD=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*://[^:]*:\([^@]*\)@.*|\1|p')
            PGHOST=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*@\([^:/]*\).*|\1|p')
            PGPORT=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*:\([0-9]*\)/.*|\1|p')
            PGDATABASE=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*/\([^?]*\).*|\1|p')
            
            export PGUSER PGPASSWORD PGHOST PGPORT PGDATABASE
            
            echo "Connecting to: $PGHOST:$PGPORT/$PGDATABASE (user: $PGUSER)"
            
            # Test connection with environment variables
            if ! psql -c "SELECT 1" 2>&1; then
              echo "::error::Cannot connect to Supabase DB with IPv4 workaround. Check SUPABASE_DB_URL secret."
              exit 1
            fi
          elif psql "$SUPABASE_DB_URL" -c "SELECT 1" > /dev/null 2>&1; then
            # Connection succeeded with direct URL
            echo "Connected successfully via URL"
            export DATABASE_URL="$SUPABASE_DB_URL"
          else
            echo ":: error::Cannot connect to Supabase DB. Check SUPABASE_DB_URL secret."
            exit 1
          fi

          echo "Connected to Supabase. Applying migrations..."

          # Loop through all SQL files in sorted order
          for file in $(ls supabase/migrations/*.sql | sort); do
            echo "Processing $file..."
            
            # Apply the migration using either DATABASE_URL or PG env vars
            if [ -n "$DATABASE_URL" ]; then
              psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$file"
            else
              psql -v ON_ERROR_STOP=1 -f "$file"
            fi
            
            if [ $? -eq 0 ]; then
              echo "✅ Successfully applied $file"
            else
              echo "::error::Failed to apply $file"
              exit 1
            fi
          done

      - name: Verify Migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          PGSSLMODE: require
        run: |
          # Use the same connection approach as the migration step
          # Just export DATABASE_URL for simplicity in queries below
          if [[ "$SUPABASE_DB_URL" == *"sslmode="* ]]; then
            export DATABASE_URL="$SUPABASE_DB_URL"
          elif [[ "$SUPABASE_DB_URL" == *"?"* ]]; then
            export DATABASE_URL="${SUPABASE_DB_URL}&sslmode=require"
          else
            export DATABASE_URL="${SUPABASE_DB_URL}?sslmode=require"
          fi
          
          echo "Verifying governance tables..."
          
          # Verify oasis_events_v1 exists
          if psql "$DATABASE_URL" -c "SELECT 1 FROM oasis_events_v1 LIMIT 1;" -t | grep -q 1; then
             echo "✅ Table oasis_events_v1 exists (or has data)"
          else
             # It might be empty but should exist. 
             # If table didn't exist, psql would error.
             # Let's check existence via information_schema to be sure
             COUNT=$(psql "$DATABASE_URL" -t -c "SELECT count(*) FROM information_schema.tables WHERE table_name = 'oasis_events_v1';")
             if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
               echo "✅ Table oasis_events_v1 exists"
             else
               echo "::error::Table oasis_events_v1 missing!"
               exit 1
             fi
          fi

          # Verify governance_rules exists
          COUNT=$(psql "$DATABASE_URL" -t -c "SELECT count(*) FROM information_schema.tables WHERE table_name = 'governance_rules';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Table governance_rules exists"
          else
            echo "::error::Table governance_rules missing!"
            exit 1
          fi

          # Verify MIGRATION_GOVERNANCE category exists (DEV-OASIS-GOV-0103)
          COUNT=$(psql "$DATABASE_URL" -t -c "SELECT count(*) FROM governance_categories WHERE name = 'MIGRATION_GOVERNANCE';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Category MIGRATION_GOVERNANCE exists"
          else
            echo "::error::Category MIGRATION_GOVERNANCE missing!"
            exit 1
          fi

          # Verify MG-001 rule exists
          COUNT=$(psql "$DATABASE_URL" -t -c "SELECT count(*) FROM governance_rules WHERE logic->>'rule_code' = 'MG-001';")
          if [ "$(echo $COUNT | xargs)" -eq "1" ]; then
            echo "✅ Rule MG-001 exists"
          else
            echo "::error::Rule MG-001 missing!"
            exit 1
          fi

      - name: Log Success to OASIS
        if: success()
        env:
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          # Optional: Log to OASIS if Gateway URL is available
          if [ -n "$GATEWAY_URL" ]; then
            curl -X POST "$GATEWAY_URL/api/v1/events/ingest" \
              -H "Content-Type: application/json" \
              -d '{
                "vtid": "DEV-OASIS-GOV-0102",
                "type": "MIGRATION_APPLIED",
                "source": "github-actions",
                "status": "success",
                "message": "Governance migrations applied successfully"
              }' || true
          fi

      - name: Log Failure to OASIS
        if: failure()
        env:
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          if [ -n "$GATEWAY_URL" ]; then
            curl -X POST "$GATEWAY_URL/api/v1/events/ingest" \
              -H "Content-Type: application/json" \
              -d '{
                "vtid": "DEV-OASIS-GOV-0102",
                "type": "MIGRATION_FAILED",
                "source": "github-actions",
                "status": "error",
                "message": "Governance migrations failed - check GitHub Actions logs"
              }' || true
          fi
